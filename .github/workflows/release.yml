name: Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build sdist
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-sdist
          path: dist

  macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-14
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: x86_64-apple-darwin
          args: --release --out dist
          sccache: "true"

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-macos-x86_64
          path: dist

  macos-aarch64:
    name: Build macOS aarch64
    runs-on: macos-14
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: aarch64-apple-darwin
          args: --release --out dist
          sccache: "true"

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-macos-aarch64
          path: dist

  windows-x86_64:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: x86_64-pc-windows-msvc
          args: --release --out dist
          sccache: "true"

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-windows-x86_64
          path: dist

  linux-x86_64:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: x86_64-unknown-linux-gnu
          manylinux: "2_17"
          args: --release --out dist
          sccache: "true"
          before-script-linux: |
            curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v33.5/protoc-33.5-linux-x86_64.zip
            python3 -m zipfile -e protoc-33.5-linux-x86_64.zip /usr/local
            rm protoc-33.5-linux-x86_64.zip
            protoc --version

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-linux-x86_64
          path: dist

  linux-aarch64:
    name: Build Linux aarch64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: aarch64-unknown-linux-gnu
          manylinux: "2_17"
          args: --release --out dist
          sccache: "true"
          before-script-linux: |
            curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v33.5/protoc-33.5-linux-aarch_64.zip
            python3 -m zipfile -e protoc-33.5-linux-aarch_64.zip /usr/local
            rm protoc-33.5-linux-aarch_64.zip
            protoc --version

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-linux-aarch64
          path: dist

  musllinux-x86_64:
    name: Build musllinux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: x86_64-unknown-linux-musl
          manylinux: musllinux_1_2
          args: --release --out dist
          sccache: "true"
          before-script-linux: |
            apk add protobuf-dev protoc

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-musllinux-x86_64
          path: dist

  musllinux-aarch64:
    name: Build musllinux aarch64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: aarch64-unknown-linux-musl
          manylinux: musllinux_1_2
          args: --release --out dist
          sccache: "true"
          before-script-linux: |
            apk add protobuf-dev protoc

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-musllinux-aarch64
          path: dist

  publish:
    name: Publish to PyPI
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs:
      - sdist
      - macos-x86_64
      - macos-aarch64
      - windows-x86_64
      - linux-x86_64
      - linux-aarch64
      - musllinux-x86_64
      - musllinux-aarch64
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: List dist contents
        run: ls -la dist/

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      - name: Publish to PyPI
        run: uv publish dist/*

      - name: Upload wheels to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: dist/*
