name: Release

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  linux:
    name: Build Linux wheels
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: ${{ github.event_name != 'workflow_dispatch' }}
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_suffix: x86_64
            manylinux: "2_17"
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact_suffix: aarch64
            manylinux: "2_17"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.platform.target }}
          manylinux: ${{ matrix.platform.manylinux }}
          args: --release --features local --out dist
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          before-script-linux: |
            ARCH="$(uname -m)"
            if [ "$ARCH" = "x86_64" ]; then
              PROTOC_ARCH="x86_64"
            elif [ "$ARCH" = "aarch64" ]; then
              PROTOC_ARCH="aarch_64"
            else
              echo "Unsupported architecture for protoc: $ARCH"
              exit 1
            fi
            PROTOC_ZIP="protoc-33.5-linux-${PROTOC_ARCH}.zip"
            curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v33.5/${PROTOC_ZIP}"
            python3 -m zipfile -e "${PROTOC_ZIP}" /usr/local
            rm "${PROTOC_ZIP}"
            chmod +x /usr/local/bin/protoc
            protoc --version

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-linux-${{ matrix.platform.artifact_suffix }}
          path: dist

  windows:
    name: Build Windows wheels
    runs-on: windows-latest
    strategy:
      fail-fast: ${{ github.event_name != 'workflow_dispatch' }}
      matrix:
        platform:
          - target: x86_64-pc-windows-msvc
            artifact_suffix: x86_64
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          version: "33.5"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.platform.target }}
          args: --release --features local --out dist
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-windows-${{ matrix.platform.artifact_suffix }}
          path: dist

  macos:
    name: Build macOS wheels
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: ${{ github.event_name != 'workflow_dispatch' }}
      matrix:
        platform:
          - runner: macos-15
            target: aarch64-apple-darwin
            artifact_suffix: aarch64
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          version: "33.5"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheel
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          target: ${{ matrix.platform.target }}
          args: --release --features local --out dist
          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Test wheel
        run: |
          pip install cangjie_mcp --find-links dist --force-reinstall
          cangjie-mcp --help
          python -m cangjie_mcp --help

      - name: Upload wheel
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-macos-${{ matrix.platform.artifact_suffix }}
          path: dist

  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install Protoc
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          version: "33.5"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build sdist
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021 # v1.50.0
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: wheels-sdist
          path: dist

  publish:
    name: Publish to PyPI
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: [linux, windows, macos, sdist]
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: "dist/*"

      - name: List dist contents
        run: ls -la dist/

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      - name: Publish to PyPI
        run: uv publish dist/*

      - name: Upload wheels to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: dist/*
